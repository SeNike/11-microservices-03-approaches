# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

# Предложение по организации инфраструктуры для разработки и эксплуатации

## Задача 1: Обеспечить разработку

### Выбор инструментов

- **Хранение исходного кода и система контроля версий:** [GitLab](https://gitlab.com/)
- **Непрерывная интеграция и непрерывная поставка (CI/CD):** [GitLab CI/CD](https://docs.gitlab.com/ee/ci/)
- **Контейнеризация:** [Docker](https://www.docker.com/)

### Описание решения

1. **GitLab как центральная платформа:**
   - **Облачная система:** GitLab предоставляет облачные решения, избавляя от необходимости управления собственными серверами.
   - **Система контроля версий Git:** Полная поддержка Git с возможностью создания отдельных репозиториев для каждого микросервиса.
   - **Репозиторий на каждый сервис:** Каждый микросервис хранится в отдельном GitLab репозитории, обеспечивая изоляцию и независимость разработки.

2. **GitLab CI/CD для автоматизации сборок и поставок:**
   - **Запуск сборки по событию из системы контроля версий:** Триггеры на основе push, merge request и других событий.
   - **Запуск сборки по кнопке с указанием параметров:** Возможность ручного запуска пайплайнов с передачей переменных.
   - **Привязка настроек к каждой сборке:** Использование `.gitlab-ci.yml` для определения настроек каждой сборки.
   - **Создание шаблонов для различных конфигураций сборок:** Использование YAML шаблонов и включений для переиспользования конфигураций.
   - **Безопасное хранение секретных данных:** GitLab CI/CD поддерживает переменные окружения с защитой секретов.
   - **Несколько конфигураций для сборки из одного репозитория:** Определение различных пайплайнов и окружений внутри одного репозитория.
   - **Кастомные шаги при сборке:** Возможность определения пользовательских скриптов и шагов в пайплайне.
   - **Собственные докер-образы для сборки проектов:** Использование Docker images в качестве runners или в качестве сред для выполнения шагов.
   - **Развертывание агентов сборки на собственных серверах:** Настройка GitLab Runners на собственных инфраструктурах для выполнения сборок.
   - **Параллельный запуск нескольких сборок и тестов:** GitLab CI/CD поддерживает параллельные джобы и динамические пайплайны.

### Обоснование выбора

GitLab предоставляет интегрированное решение, объединяющее систему контроля версий и CI/CD, что упрощает управление и интеграцию между компонентами. Облачная платформа обеспечивает масштабируемость и доступность, а гибкость GitLab CI/CD позволяет удовлетворить все заявленные требования по автоматизации и безопасности.

## Задача 2: Логи

### Выбор инструментов

- **Сбор логов:** [Fluentd](https://www.fluentd.org/) или [Fluent Bit](https://fluentbit.io/)
- **Центральное хранилище логов:** [Elasticsearch](https://www.elastic.co/elasticsearch/)
- **Анализ и визуализация:** [Kibana](https://www.elastic.co/kibana/)
- **Логирование в Docker:** Использование драйвера `fluentd` для контейнеров

### Описание решения

1. **Сбор логов:**
   - **Fluentd/Fluent Bit:** Агент устанавливается на всех хостах, собирает логи из `stdout` контейнеров и отправляет в Elasticsearch.
   - **Минимальные требования к приложениям:** Приложения продолжают выводить логи в `stdout`, без необходимости дополнительной конфигурации.

2. **Централизованное хранилище:**
   - **Elasticsearch:** Хранит и индексирует логи, обеспечивая быстрый поиск и фильтрацию.

3. **Анализ и визуализация:**
   - **Kibana:** Предоставляет пользовательский интерфейс для поиска, фильтрации и визуализации логов.
   - **Гарантированная доставка логов:** Fluentd гарантирует доставку логов в Elasticsearch с возможностью ретрансляции при сбоях.

4. **Доступ разработчиков:**
   - **Kibana Dashboards:** Разработчикам предоставляется доступ к Kibana с возможностью создавать и сохранять поисковые запросы, а также делиться ссылками на сохраненные поиски.

### Обоснование выбора

Стек ELK (Elasticsearch, Logstash/Fluentd, Kibana) является стандартным решением для централизованного сбора и анализа логов. Использование Fluentd обеспечивает гибкость и надежность в транспортировке логов, а Elasticsearch и Kibana предоставляют мощные инструменты для поиска и визуализации, удовлетворяя все заявленные требования.

## Задача 3: Мониторинг

### Выбор инструментов

- **Сбор метрик:** [Prometheus](https://prometheus.io/)
- **Визуализация и дашборды:** [Grafana](https://grafana.com/)
- **Экспортеры метрик:** [Node Exporter](https://github.com/prometheus/node_exporter) для хостов и специализированные экспортеры для сервисов

### Описание решения

1. **Сбор метрик:**
   - **Prometheus:** Устанавливается в облаке для сбора метрик со всех хостов и сервисов через HTTP.
   - **Node Exporter:** Устанавливается на каждом хосте для сбора метрик CPU, RAM, HDD, Network.
   - **Специфичные экспортеры:** Используются для сбора метрик, специфичных для каждого микросервиса (например, JVM Exporter для Java приложений).

2. **Хранение и обработка метрик:**
   - **Prometheus:** Сохраняет временные ряды метрик и обеспечивает высокую производительность при запросах.

3. **Визуализация и пользовательский интерфейс:**
   - **Grafana:** Подключается к Prometheus для создания настраиваемых дашбордов, позволяющих агрегировать и визуализировать информацию.
   - **Настраиваемые панели:** Пользователи могут создавать различные панели для отслеживания состояния системы в реальном времени.

4. **Функциональные возможности:**
   - **Сбор метрик состояния ресурсов хостов и потребляемых ресурсов сервисами:** Prometheus в сочетании с Node Exporter и сервисными экспортерами обеспечивает полный охват метрик.
   - **Специфичные метрики для каждого сервиса:** Гибкость Prometheus позволяет добавлять новые экспортеры по мере необходимости.
   - **Запросы и агрегирование информации:** PromQL в Prometheus предоставляет мощные возможности для запроса и агрегации метрик.
   - **Пользовательский интерфейс:** Grafana предоставляет удобный и интуитивно понятный интерфейс для настройки и просмотра дашбордов.

### Обоснование выбора

Prometheus и Grafana являются де-факто стандартом для мониторинга и визуализации метрик в современных микросервисных архитектурах. Prometheus обеспечивает надежный и масштабируемый сбор метрик, а Grafana предоставляет мощные инструменты для создания настраиваемых панелей и визуализаций. Вместе они удовлетворяют все заявленные требования по сбору, анализу и отображению состояния системы.

# Заключение

Предложенные решения основаны на проверенных и широко используемых инструментах, обеспечивающих интеграцию, масштабируемость и надежность. Использование GitLab для разработки и CI/CD, стека ELK для логирования и Prometheus с Grafana для мониторинга позволит создать эффективную и устойчивую инфраструктуру для микросервисной архитектуры компании.


